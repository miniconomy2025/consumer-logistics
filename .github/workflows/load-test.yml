name: Load Testing

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type'
        required: true
        default: 'smoke'
        type: choice
        options: [smoke, load, stress, spike]
      environment:
        description: 'Environment'
        required: true
        default: 'prod'
        type: choice
        options: [dev, prod]
  pull_request:
    paths: ['backend/**']

jobs:
  load-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install k6
      run: |
        wget -q -O - https://dl.k6.io/key.gpg | sudo apt-key add -
        echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
    
    - name: Create results directory
      run: mkdir -p load-testing/results
    
    - name: Run Load Test
      working-directory: ./load-testing
      run: |
        TEST_TYPE=${{ github.event.inputs.test_type || 'smoke' }}
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        k6 run --out json=results/${TEST_TYPE}-${TIMESTAMP}.json tests/${TEST_TYPE}-test.js
      env:
        ENVIRONMENT: ${{ github.event.inputs.environment || 'prod' }}
        BACKEND_URL: ${{ secrets.BACKEND_URL }}
        API_KEY: ${{ secrets.API_KEY }}
    
    - name: Upload Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: load-test-results
        path: load-testing/results/